
---
layout: post
title: k8s资源类型
category: kubernets
tags: [k8s 资源类型]
---

## 资源类型

自主式pod

* 这种Pod本身是不能自我修复的，当Pod被创建后（不论是由你直接创建还是被其他Controller），都会被Kuberentes调度到集群的Node上。直到Pod的进程终止、被删掉、因为缺少资源而被驱逐、或者Node故障之前这个Pod都会一直保持在那个Node上。Pod不会自愈。如果Pod运行的Node故障，或者是调度器本身故障，这个Pod就会被删除。同样的，如果Pod所在Node缺少资源或者Pod处于维护状态，Pod也会被驱逐。

控制器管理pod

* Kubernetes使用更高级的称为Controller的抽象层，来管理Pod实例。Controller可以创建和管理多个Pod，提供副本管理、滚动升级和集群级别的自愈能力。例如，如果一个Node故障，Controller就能自动将该节点上的Pod调度到其他健康的Node上。虽然可以直接使用Pod，但是在Kubernetes中通常是使用Controller来管理Pod的。

资源控制器分类

* ReplicaSet
  * 确保容器应用的副本数保持在用户定义的副本数
  * 不支持rolling update，建议使用deployment
* Deployment
* StatefulSet
  * 有状态服务
  * 稳定的网络标志，即pod重新调度后podname和hostname 不变，headless service实现（没有cluster ip的service）
  * 稳定的持久化存储，重新调度后还是能访问相同的数据卷。
  * 有序部署，有序扩展，有序回收，即从0 - n-1在下一个pod运行之前所有之前的pod都是running和Ready状态。
* DaemonSet
  * 确保全部node\(或一些node\)运行一个pod副本，当有node加入集群时也会为他们新增一个pod,当有node从集群中移除时，这些也会被回收。
* Job
  * 负责批处理任务，保证批处理的一个或多个pod成功结束。
* Cronjob
  * 管理基于时间的job,给定时间内只运行一次，周期性的在指定时间内运行。
* HPA
  * Horizontal Pod Autoscaling可以根据CPU利用率自动伸缩一个Replication Controller、Deployment 或者Replica Set中的Pod数量。

资源控制器会通过matchLabels对象，管理标签名为backend-acount的模版。pod是由template对象生成的，所以pod的标签继承template的标签为backend-account，通过kubectl get pod --show lables 查看。

如果手动修改其中一个pod的标签名使其不等于backend-account,则资源管理会失去对这个pod的管理权限，从而根据replicas生成新的标签为backend-acount的pod。删除控制也不会影响到修改标签后的的pod.

```text
spec:
  replicas: 0
  selector:
    matchLabels:
      name: backend-account
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        name: backend-account
```

扩容命令：

```text
kubectl scale deployment <控制器名字> --replicas=3
```

更新镜像

```text
kubectl set image deploy backend-account backend-account=nginx:1.9.1 
```

更新所有镜像

```text
kubectl set image deploy *=nginx:1.9.1 --all
```

回滚

```text
kubectl rollout  undo  deploy
```

从本地文件更新镜像

```text
kubectl set image -f path/to/file.yaml nginx=nginx:1.9.1 --local -o yaml
```

Deployment控制器更新策略

```text
strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 25%
    type: RollingUpdate
```

* maxSurge:
  * 升级过程中最多可以比原先设置多出的POD数量
  * 例如：maxSurage=1，replicas=5,则表示Kubernetes会先启动1一个新的Pod后才删掉一个旧的POD，整个升级过程中最多会有5+1个POD。
* maxUnavaible:
  * 升级过程中最多有多少个POD处于无法提供服务的状态

查看历史更新版本

```text
kubectl rollout history deploy backend-account
```

> 只有apply 服务时后面加--record 才能看到历史



  



